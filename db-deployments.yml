# ğŸ—‚ï¸ Define a Persistent Volume Claim (PVC) for MySQL â€” dynamic provisioning by cluster (via default StorageClass)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim # ğŸ“¦ Name of the PVC â€” used in Deployment to mount volumes
  labels:
    app: mysql
    tier: database
spec:
  accessModes:
    - ReadWriteOnce  # ğŸ“ Only one node can mount this volume as read-write at a time
  resources:
    requests:
      storage: 1Gi   # ğŸ’¾ Request 1Gi of dynamic storage from the default storage class
---
# âš™ï¸ Define a Deployment to manage MySQL Pod
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql # ğŸ‘· Name of the deployment
  labels:
    app: mysql
    tier: database
spec:
  selector:
    matchLabels:
      app: mysql       # âœ… MUST match the Pod template labels below
      tier: database
  strategy:
    type: Recreate     # ğŸ” Recreate Pod when changes happen (safer for DB containers)
  template:
    metadata:
      labels:
        app: mysql     # âœ… Labels applied to the Pod created by this deployment
        tier: database #    Must match the Service's selector to connect
    spec:
      containers:
        - image: mysql:8.4  # ğŸ¬ MySQL image pulled from DockerHub
          name: mysql       # Name of the container inside the Pod
          env:              # ğŸ” Environment variables passed into the container
            - name: MYSQL_ROOT_PASSWORD
              value: root   # ğŸ” Root password for MySQL

            # Optional: use secret for secure password handling
            #            valueFrom:
            #              secretKeyRef:
            #                name: mysql-secrets
            #                key: password

            - name: MYSQL_DATABASE
              value: mydb  # ğŸ“‚ Default database to create (used in Spring Boot config)
            - name: MYSQL_USER
              value: user
            - name: MYSQL_PASSWORD
              value: user

          # Optional: use ConfigMap to externalize DB values
          #            valueFrom:
          #              configMapKeyRef:
          #                name: db-config
          #                key: dbName

          ports:
            - containerPort: 3306 # ğŸ“¡ MySQL default port exposed by the container
              name: mysql

          volumeMounts:          # ğŸ”„ Mount volume inside the container
            - name: mysql-persistent-storage
              mountPath: /var/lib/mysql # ğŸ’¾ MySQL stores data here by default

      volumes:
        - name: mysql-persistent-storage
          persistentVolumeClaim:
            claimName: mysql-pv-claim  # ğŸ”— Link the volume to our PVC defined above
---
# ğŸŒ Define a Service to expose MySQL to other services (like Spring Boot app)
apiVersion: v1
kind: Service
metadata:
  name: mysql-db  # ğŸ“› This becomes the DNS name for other services (e.g., springboot-app talks to mysql-db)
  labels:
    app: mysql
    tier: database
spec:
  ports:
    - port: 3306        # ğŸ¯ Exposes MySQL port at 3306
      targetPort: 3306  #    Maps to the container's port 3306
  selector:
    app: mysql          # ğŸ¯ Targets Pods with these labels (must match Deployment)
    tier: database
  clusterIP: None       # ğŸ“¡ Headless service (DNS lookup returns Pod IPs directly, useful for StatefulSets or simple access)